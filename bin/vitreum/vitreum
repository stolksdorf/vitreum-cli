#!/usr/bin/env node

const path = require('path');
const fse   = require('fs-extra');
const chalk = require('chalk');

const location = process.cwd();
const success = (msg) => console.log(chalk.green('âœ“ ') + msg);

const templates = Object.assign(
	require('./vitreum.templates.js'),
	require('../jsx/jsx.templates.js')
);

let LIBS = [
	'lodash',
	'react',
	'react-dom',
	'create-react-class',
	'classnames',
	'express',
	'vitreum',
	'nconf',
	'pico-router'
];

let DEV_LIBS = ['cross-env', 'fixme'];

let package = {};

const loadPackage = () => {
	return new Promise((resolve, reject) => {
		fse.readJson('./package.json', (err, packageObj) => {
			if(err) return reject('No package.json found. try running `npm init` first');
			package = packageObj;
			return resolve(packageObj);
		});
	});
};

const updatePackage = () => {
	package.main = 'server.js';

	package.scripts.dev         = "node scripts/dev.script.js";
	package.scripts.build       = "node scripts/build.script.js";
	package.scripts.prod        = "cross-env NODE_ENV=production && npm run build && npm run start";
	package.scripts.postinstall = "npm run build";
	package.scripts.start       = "node app.js";
	package.scripts.todo        = "fixme -i build/** -i node_modules/** **/*.{js,jsx,less}";

	fse.writeJsonSync('./package.json', package);
	success('updated package.json');
};

const makeClient = ()=>{
	//add in a routing comp
	//add in pages
	fse.outputFileSync('./client/main/main.jsx', templates.jsx('main'));
	fse.outputFileSync('./client/main/main.less', templates.less('main'));
	success('created main component');
};

const makeServer = () => {
	fse.outputFileSync('./app.js', templates.app())
	fse.outputFileSync('./server/server.js', templates.server());
	fse.outputFileSync('./server/basic.router.js', templates.router());
	fse.outputFileSync('./server/page.template.js', templates.template());
	success('created server files');
};

const makeDotFiles = () => {
	fse.outputFileSync('.gitignore', ['*.log', 'build', 'node_modules', 'config/local.json'].join('\n'));
	fse.outputFileSync('.gitattributes', 'package-lock.json binary');
	success('created dot files: .gitignore, .gitattributes');
};

const makeConfig = ()=>{
	fse.outputJsonSync('./config/default.json', {
		port : 8000,
		client : {api_route : ''}
	});
	fse.outputJsonSync('./config/local.json', {
		client : {api_route : 'test.com/api'}
	});
	success('created configs');
};

const makeScripts = ()=>{
	fse.outputFileSync('./scripts/project.js', templates.scripts.project(LIBS));
	fse.outputFileSync('./scripts/build.script.js', templates.scripts.build());
	fse.outputFileSync('./scripts/dev.script.js', templates.scripts.dev());
	success('created build scripts');
};

const makeShared = ()=>{
	//add in component index
	//add in config file
	fse.outputFileSync('./client/shared/widget/widget.jsx', templates.jsx('widget'));
	fse.outputFileSync('./client/shared/widget/widget.less', templates.less('widget'));
	fse.outfileFileSync('./client/shared/components.js', `module.exports = {
	Widget : require('./widget/widget.jsx'),
};`);
	success('created shared');
};

const makeLinting = ()=>{
	DEV_LIBS.push('eslint');
	DEV_LIBS.push('eslint-plugin-react');
	package.scripts['lint'] = 'eslint --fix **/*.{js,jsx}';
	package.scripts['lint:dry'] = 'eslint **/*.{js,jsx}';

	fse.outputFileSync('./.eslintrc.js', templates.eslint());

	success('created linting');
};

const makeTests = ()=>{
	//switch over to tape
	DEV_LIBS.push('tape');
	DEV_LIBS.push('faucet');
	package.scripts['test'] = 'ava -s -v';
	package.scripts['test:dev'] = 'ava -w';

	fse.outputFileSync('./tests/basic.test.js', templates.test());

	success('created tests');
};

const makeReactTests = ()=>{
	//add react-test renderer
	//add babel register
}


const done = () => {
	console.log('done!');
	console.log('\nInstall the following libs:\n');
	console.log(chalk.cyan(`  npm i ${LIBS.join(' ')}`));
	console.log(chalk.yellow(`  npm i -D ${DEV_LIBS.join(' ')}\n`));

	//TODO: add suggestions for optional libs, date-fns, your style module, etc.
};


loadPackage()
	.then(makeClient)
	.then(makeServer)
	.then(makeShared)
	.then(makeDotFiles)
	.then(makeConfig)
	.then(makeLinting)
	.then(makeTests)
	.then(updatePackage)
	.then(makeScripts)
	.then(done)
	.catch(console.error)
